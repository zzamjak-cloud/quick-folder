name: "Publish Release"

on:
  push:
    tags:
      - 'v*' # v1.0.0 같은 태그가 푸시될 때 실행

jobs:
  publish:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "macos-latest" # Mac 빌드용
            args: "--target universal-apple-darwin" # Intel/M1 통합 바이너리
          - platform: "windows-latest" # Windows 빌드용
            args: ""

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      # 1. Node.js 환경 세팅
      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm' # 또는 yarn, pnpm

      # 2. Rust 환경 세팅
      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable

      # 2-1. macOS universal binary를 위한 Rust 타겟 추가
      - name: install Rust targets for macOS
        if: matrix.platform == 'macos-latest'
        run: rustup target add aarch64-apple-darwin x86_64-apple-darwin

      # 3. Rust 빌드 캐시 (빌드 속도 향상)
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      # 4. 프론트엔드 의존성 설치
      - name: install frontend dependencies
        run: npm install # 혹은 yarn install, pnpm install

      # 5. Tauri 빌드 및 GitHub Release 생성 (서명 포함)
      - name: build and release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: ${{ github.ref_name }} # 태그 이름을 버전으로 사용
          releaseName: "QuickFolder Widget v__VERSION__"
          releaseBody: "See the assets to download and install this version."
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }}

  # 모든 빌드 완료 후 update.json 자동 생성
  update-json:
    needs: publish
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate update.json
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION_NUM="${VERSION#v}"  # v1.0.0 -> 1.0.0

          # GitHub Release에서 asset 정보 가져오기
          RELEASE_DATA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/${VERSION}")

          # DMG 및 NSIS 파일 URL과 서명 추출
          DMG_URL=$(echo "$RELEASE_DATA" | jq -r '.assets[] | select(.name | endswith(".dmg.tar.gz")) | .browser_download_url')
          DMG_SIG=$(echo "$RELEASE_DATA" | jq -r '.assets[] | select(.name | endswith(".dmg.tar.gz.sig")) | .browser_download_url' | xargs curl -sL)

          NSIS_URL=$(echo "$RELEASE_DATA" | jq -r '.assets[] | select(.name | endswith(".nsis.zip")) | .browser_download_url')
          NSIS_SIG=$(echo "$RELEASE_DATA" | jq -r '.assets[] | select(.name | endswith(".nsis.zip.sig")) | .browser_download_url' | xargs curl -sL)

          # update.json 생성
          cat > update.json << EOF
          {
            "version": "${VERSION_NUM}",
            "notes": "Release ${VERSION}",
            "pub_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platforms": {
              "darwin-universal": {
                "signature": "${DMG_SIG}",
                "url": "${DMG_URL}"
              },
              "windows-x86_64": {
                "signature": "${NSIS_SIG}",
                "url": "${NSIS_URL}"
              }
            }
          }
          EOF

          cat update.json

      - name: Commit and push update.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add update.json
          git commit -m "chore: update update.json for ${{ github.ref_name }}" || echo "No changes to commit"
          git push origin main